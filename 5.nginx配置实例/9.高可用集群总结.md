# 1. é«˜å¯ç”¨é›†ç¾¤æ€»ç»“

## 1.1 ä»€ä¹ˆæ˜¯é«˜å¯ç”¨
nginxä¹Ÿå­˜åœ¨å®•æœºçš„æƒ…å†µï¼Œå½“nginxå®•æœºåï¼ŒæœåŠ¡å°†æ— æ³•è¢«ç”¨æˆ·è¯·æ±‚ã€‚
![](../assets/nginxå®•æœº.png)

ä¸ºäº†å®ç°nginxæŸå°æœåŠ¡å®•æœºä¹Ÿå¯ä½¿ç”¨ï¼Œåˆ™ä½¿ç”¨ nginxä¸»ä»é…ç½®ã€‚
![](../assets/é«˜å¯ç”¨æ¦‚å¿µ.png)

### éœ€è¦çš„é…ç½®
* éœ€è¦ 2å°nginxæœåŠ¡å™¨
* éœ€è¦ keepalived
* éœ€è¦ è™šæ‹Ÿip

## 1.2 /etc/keepalived/keepalived.conf æ–‡ä»¶å†…å®¹

/etc/keepalived/keepalived.conf æ–‡ä»¶å†…å®¹å¦‚ä¸‹:

```shell script
! Configuration File for keepalived

global_defs {
   notification_email {
        test@example.com
   }
   notification_email_from research@nagios3.com
   smtp_server 127.0.0.1
   smtp_connect_timeout 30
   router_id NGINX_DEVEL #æœ€é‡è¦çš„å€¼ï¼Œä¹Ÿå¯ä»¥å†™æˆIP
}

#æ£€æµ‹è„šæœ¬ å’Œ æƒé‡çš„å‚æ•°
vrrp_script chk_http_port {
    script "/usr/local/nginx/monitor_nginx.sh"
    interval 2 #æ£€æµ‹è„šæœ¬æ‰§è¡Œæ—¶é—´
    weight -2
    fall 3
    rise 2    
}

# è™šæ‹Ÿçš„ç¬¬1ä¸ªipé…ç½®
vrrp_instance VI_1 {
    state MASTER # ä¸»æœåŠ¡å™¨åˆ™ä¸º MASTERï¼Œå¤‡ä»½æœåŠ¡å™¨ä¸º BACKUP
    interface em1 #ç½‘å¡
    virtual_router_id 104 # ä¸»ã€å¤‡æœºçš„ virtual_router_idå€¼å¿…é¡»ç›¸åŒ
    priority 100 # ä¸»ã€å¤‡æœºå–ä¸åŒçš„ä¼˜å…ˆçº§ï¼Œä¸»æœºå€¼è¾ƒå¤§ï¼Œå¤‡ä»½æœºå€¼è¾ƒå°
    advert_int 1 # æ¯éš”å¤šå°‘æ—¶é—´æ£€æµ‹å¿ƒè·³ï¼Œé»˜è®¤æ¯éš”1sæ£€æµ‹1æ¬¡ğŸ’“
    mcast_src_ip 192.138.86.1
    authentication {
        auth_type PASS
        auth_pass 1234
    }
    virtual_ipaddress {
        192.138.86.3 # VRRP Hè™šæ‹Ÿåœ°å€
    }
    track_interface {
        em1
    }
    track_script {
        chk_http_port
    }
}

# è™šæ‹Ÿçš„ç¬¬2ä¸ªipé…ç½®
vrrp_instance VI_2 {
    state BACKUP
    interface em1
    virtual_router_id 105
    priority 90
    advert_int 1
    mcast_src_ip 192.138.86.1
    authentication {
        auth_type PASS
        auth_pass 1234
    }
    virtual_ipaddress {
        192.138.86.4
    }
    track_interface {
        em1
    }
    track_script {
        chk_http_port
    }
}
```
